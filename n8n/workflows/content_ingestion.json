{
  "name": "Ontoiq: Content Ingestion (Native)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      },
      "id": "trigger-schedule",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [50, 300]
    },
    {
      "parameters": {
        "fileSelector": "/vault/raw/**/*.md",
        "options": {
          "recursive": true
        }
      },
      "id": "read-binary-files",
      "name": "Read Binary Files",
      "type": "n8n-nodes-base.readBinaryFiles",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "fields": {
          "values": [
            {
              "name": "source_type",
              "type": "string",
              "value": "={{ $binary.fileName.split('/')[2] }}"
            },
            {
              "name": "title",
              "type": "string",
              "value": "={{ $binary.fileName.split('/').pop().replace('.md', '') }}"
            },
            {
              "name": "raw_content",
              "type": "string",
              "value": "={{ $binary.data.toString() }}"
            },
            {
              "name": "domain_slug",
              "type": "string",
              "value": "={{ $binary.data.toString().match(/^domain:\s*(.+)$/m)?.[1] || 'daily-journal' }}"
            },
            {
              "name": "url",
              "type": "string",
              "value": "={{ $binary.data.toString().match(/^url:\s*(.+)$/m)?.[1] || null }}"
            },
            {
              "name": "author",
              "type": "string",
              "value": "={{ $binary.data.toString().match(/^author:\s*(.+)$/m)?.[1] || null }}"
            }
          ]
        }
      },
      "id": "edit-fields-parse",
      "name": "Parse Frontmatter",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id FROM knowledge_domains WHERE slug = $1",
        "options": {
          "mode": "each"
        },
        "parameters": [
          {
            "name": "slug",
            "value": "={{ $json.domain_slug }}"
          }
        ]
      },
      "id": "postgres-lookup-domain",
      "name": "Lookup Domain ID",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [650, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-ontoiq",
          "name": "Ontoiq Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": "public",
        "table": "content_sources",
        "columns": {
          "source_type": "={{ $json.source_type }}",
          "title": "={{ $json.title }}",
          "url": "={{ $json.url }}",
          "author": "={{ $json.author }}",
          "raw_content": "={{ $json.raw_content }}",
          "processing_state": "pending",
          "domain_id": "={{ $node['Lookup Domain ID'].first().json.id }}"
        },
        "options": {
          "ignoreOnConflict": true
        }
      },
      "id": "postgres-upsert-source",
      "name": "Upsert Content Source",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [850, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-ontoiq",
          "name": "Ontoiq Postgres"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $binary.fileName.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "if-has-files",
      "name": "Has New Files?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [250, 100]
    },
    {
      "parameters": {
        "chatId": "={{ $vars.USER_TELEGRAM_ID }}",
        "text": "üì• Content ingestion: {{ $json.length }} new files processed"
      },
      "id": "telegram-success",
      "name": "Notify Success",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [1050, 300],
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $vars.USER_TELEGRAM_ID }}",
        "text": "‚ö†Ô∏è Content ingestion: No new files found"
      },
      "id": "telegram-no-files",
      "name": "Notify No Files",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [450, 500],
      "credentials": {
        "telegramApi": {
          "id": "telegram-bot",
          "name": "Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Read Binary Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Binary Files": {
      "main": [
        [
          {
            "node": "Has New Files?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has New Files?": {
      "main": [
        [
          {
            "node": "Parse Frontmatter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify No Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Frontmatter": {
      "main": [
        [
          {
            "node": "Lookup Domain ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lookup Domain ID": {
      "main": [
        [
          {
            "node": "Upsert Content Source",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Content Source": {
      "main": [
        [
          {
            "node": "Notify Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [
    {
      "name": "ontoiq",
      "color": "#3b82f6"
    },
    {
      "name": "ingestion",
      "color": "#10b981"
    },
    {
      "name": "native",
      "color": "#22c55e"
    }
  ]
}
